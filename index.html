<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">

				<section class="present" style="top: 0px; display: block;">
					<h2>Gulp under the hood</h2>
					<h1>
					<img src="gulp-2x.png" style="border:0px; background:0000">
					</h1>
					<p>
						<small><a href="http://github.com/mikhail.angelov">Михаил Ангелов</a> / <a href="https://twitter.com/MikhailAngelov">@MikhailAngelov</a></small>
					</p>
				</section>

				<section>
					<h2>Для чего нужна автоматизация</h2>
					<p>
						
					</p>
				</section>


				<section data-background="under.jpg">
					<!-- <h2>заглянем подкапот </h2> -->
				</section>


					<section>
						<h4>Gulp API</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
gulp.task
gulp.src
gulp.dest
gulp.watch

						</code></pre>
					</section>
					<section>
						<h4>Элементарная задача Gulp</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
gulp.task('test', function{
    gulp.src('test.txt')
    .<span class="fragment highlight-green">pipe</span>(gulp.dest('out'));
});
						</code></pre>
						<h4>команда запуска</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
gulp test
						</code></pre>
					</section>


				<section>
					<h4>сделаем свой gulp</h4>
					<img height="238" data-src="bike.jpg">
				</section>


					<section>
						<h4>Элементарная задача Gulp</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plug.js
var tasks = {};
module.exports = {
    task: onTask
};
function onTask(name, callback){
    tasks[name] = callback;
}

process.nextTick(function(){
    var taskName = process.argv[2];
    tasks[taskName]();
});
						</code></pre>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plugfile.js
var plug = require('./plug');

plug.task('test', function(){
    console.log('hello plug');
});
						</code></pre>
					</section>
					<section>
						<h4>запустим</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
node plugfile.js test
						</code></pre>
						<h4>получим результат</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
hello plug
						</code></pre>
					</section>


					<section>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plug.js
var stream = require('stream');
var fs = require('fs');
function onSrc(fileName){
    var src = stream.Readable({
        read: function (chunk) {},
        <span class="fragment highlight-red">objectMode: true</span>
    });
    fs.readFile(path, 'utf8', (e,data)=> {
        src.push({
            name: path,
            buffer: data
        });
        src.push(null);
    });
    return src;
}
						</code></pre>
					</section>
					<section>
					<h4>Структура объекта в потоке</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
{
  name: path, //file name
  buffer: data //file content
}
						</code></pre>
					</section>


					<section>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plug.js
function onDest(path){
    var writer = new stream.Writable({
        write: function (chunk, encoding, next) {
            if (!fs.existsSync(path)) fs.mkdirSync(path);
            fs.writeFile(path +'/'+ chunk.name, chunk.buffer, next);
        },
        objectMode: true
    });
    return writer;
}
						</code></pre>
					</section>
					<section>
						<h4>обновим plug file</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plugfile.js
var plug = require('./plug');

plug.task('test', function(){
    plug.src('test.txt')
    .pipe(plug.dest('out'))
})
						</code></pre>
						<h4>получим результат</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
>touch test.txt
>node plugfile.js test
>ls  ./out
test.txt
						</code></pre>
					</section>


					<section>
					<h4>Воспользуемся библиотекой vinyl-fs</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plug.js
var vfs = require('vinyl-fs')

function onSrc(fileName){
    return vfs.src(fileName);
}

function onDest(path){
    return vfs.dest(path);
}
						</code></pre>
					</section>
					<section>
						<pre><code data-trim="" data-noescape="" class="javascript">
>node plugfile.js test
						</code></pre>
					</section>

					<section>

						<pre><code data-trim="" data-noescape="" class="javascript">
>npm i gulp-rename
						</code></pre>
					</section>
					<section>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plugfile.js
var plug = require('./app.js');
var rename = require('gulp-rename');

plug.task('test', function () {
    return plug.src('test.txt')
        .pipe(rename('renamed.txt'))
        .pipe(plug.dest('out'));
});
						</code></pre>
					</section>


					<section>
					<h4>Последняя API по порядку а не по значению </h4>
					<pre><code class="hljs"  data-trim contenteditable>
//plug.js
var plug = {
    task: onTask,
    src: onSrc,
    dest: onDest,
    watch: onWatch
};

function onWatch(fileName, taskName){
    fs.watchFile(fileName, (event, filename) => {
        if (filename) {
            tasks[taskName]();
        }
    });
}
					</code></pre>
					</section>
					<section>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plugfile.js

plug.watch('test.txt','test');
						</code></pre>
						<pre><code data-trim="" data-noescape="" class="javascript">
>node plug test
						</code></pre>
					</section>


				<section>
					<h4>Заключение</h4>

				</section>

				<section style="text-align: left;">
					<h1>THE END</h1>
					<p>
						<a href="https://twitter.com/MikhailAngelov">@MikhailAngelov</a></small>
					</p>
					<p>
						<a href="https://github.com/mikhail-angelov/gulp-presentation">ссылка на презентацию</a>
					</p>
				</section>


					<section>
						<h4>Что же нового будет в Gulp 4?</h4>
					</section>
					<section>
						<pre><code data-trim="" data-noescape="" class="javascript">
gulp.parallel
gulp.series
						</code></pre>
					</section>


				<section>
					<h4>изменим файл конфигурации</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plugfile.js
var plug = require('./plug');
plug.task('sTask1', () => {
    return plug.src('test1.txt')
    .pipe(plug.dest('out'))
});
plug.task('sTask2', () => {
    return plug.src('test2.txt')
    .pipe(plug.dest('out'))
});
plug.task('test-series', plug.parallel(['sTask1', 'sTask2']), ()=>{
    console.log('done')
});
plug.task('test-parallel', plug.series(['sTask1', 'sTask2']), ()=>{
    console.log('done')
});
						</code></pre>
				</section>
				<section>
				<h4>изменим регистрацию под задач</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
//plug.js
function onTask(name, subTasks, callback){
    if(arguments.length === 2 && typeof arguments[1] === 'function'){
        callback = subTasks;
        subTasks = {series: []};
    }
    tasks[name] = subTasks;
    tasks[name].callback = function(){
        if(callback) return callback();
    };
}
function onParallel(tasks){
    return {parallel: tasks};
}
function onSeries(tasks){
    return {series: tasks}; 
}
						</code></pre>
				</section>

				<section>
						<pre><code data-trim="" data-noescape="" class="javascript" style="max-height: 600px; font-size: 15px; line-height: 100%;">
//plug.js
var async = require('async')

function _processTask(taskName, callback){
            var taskInfo = tasks[taskName];
            console.log('task ' + taskName + ' is started');

            var subTaskNames = taskInfo.series || taskInfo.parallel || [];
            var subTasks = subTaskNames.map(function(subTask){
                return function(cb){
                    _processTask(subTask, cb);
                }
            });

            if(subTasks.length>0){
                if(taskInfo.series){
                    async.series(subTasks, taskInfo.callback);
                }else{
                    async.parallel(subTasks, taskInfo.callback);
                }
            }else{
                var stream = taskInfo.callback();
                if(stream){
                    stream.on('end', function(){
                        console.log('stream ' + taskName + ' is ended');
                        callback()
                    })
                }else{
                    console.log('task ' + taskName +' is completed');
                    callback();
                }
            }

}
process.nextTick(function(){
    var taskName = process.argv[2];
    _processTask(taskName, function(){
    	console.log('done');
    });
});
						</code></pre>
				</section>


					<section>
						<h4>результат выполнения первой задачи</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
>node plugFile.js test-series

task test-series is started
task subTask1 is started
stream subTask1 is ended
task subTask2 is started
stream subTask2 is ended
done
						</code></pre>
					</section>
					<section>
						<h4>результат выполнения второй задачи</h4>
						<pre><code data-trim="" data-noescape="" class="javascript">
>node plugFile.js test-parallel

task test-parallel is started
task subTask1 is started
task subTask2 is started
stream subTask2 is ended
stream subTask1 is ended
done
						</code></pre>
					</section>


				<section style="text-align: left;">
					<h1>Вот теперь все :)</h1>
					<p>
						<a href="https://twitter.com/MikhailAngelov">@MikhailAngelov</a></small>
					</p>
										<p>
						<a href="https://github.com/mikhail-angelov/gulp-presentation">ссылка на презентацию</a>
					</p>
				</section>

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				history: true,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
